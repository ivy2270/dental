<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>診所燈號系統</title>
<link rel="icon" type="image/svg+xml" href="vertical-traffic-light-svgrepo-com.svg">
    <style>
        body { font-family: sans-serif; background: #f0f2f5; margin: 0; padding: 10px; overflow: hidden; }
        .container { display: flex; flex-direction: column; gap: 10px; }
        .room-row { display: flex; align-items: center; justify-content: space-between; 
                   background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .room-name { font-weight: bold; font-size: 16px; color: #333; }
        .light { width: 40px; height: 40px; border-radius: 50%; cursor: pointer; border: 3px solid #ddd; transition: 0.3s; }
        .light.red { background-color: #ff4d4f; box-shadow: 0 0 10px #ff4d4f; }
        .light.green { background-color: #52c41a; box-shadow: 0 0 10px #52c41a; }
        .disabled { cursor: not-allowed; opacity: 0.6; }
        #loading { position: fixed; top: 0; right: 0; font-size: 10px; color: #ccc; padding: 5px; }
    </style>
</head>
<body>

<div id="loading">同步中...</div>
<div id="app" class="container">
    </div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbyCTfASN8xBtckViSGKFi0099zy7RfH1P2k7xqkNHP1H-b2sGKPNX30LRSRpXASIYTD/exec"; 
    const urlParams = new URLSearchParams(window.location.search);
    const myRoomId = urlParams.get('room');

    // JSONP 請求工具
    function jsonp(url) {
        return new Promise((resolve) => {
            const callbackName = 'jsonp_cb_' + Math.round(100000 * Math.random());
            window[callbackName] = (data) => {
                delete window[callbackName];
                document.body.removeChild(script);
                resolve(data);
            };
            const script = document.createElement('script');
            script.src = `${url}${url.indexOf('?') >= 0 ? '&' : '?'}callback=${callbackName}`;
            document.body.appendChild(script);
        });
    }

    async function refreshStatus() {
        try {
            const data = await jsonp(`${GAS_URL}?action=getStatus`);
            render(data);
            document.getElementById('loading').innerText = '已同步';
        } catch (e) {
            document.getElementById('loading').innerText = '同步中...';
        }
    }

    async function toggle(id) {
        if (myRoomId !== null && myRoomId != id) return;
        document.getElementById('loading').innerText = '傳送中...';
        await jsonp(`${GAS_URL}?action=toggle&roomId=${id}`);
        refreshStatus();
    }

    // render 函式保持不變...
    // setInterval(refreshStatus, 3000) 保持不變...

    // 繪製介面
    function render(data) {
        const app = document.getElementById('app');
        app.innerHTML = '';

        data.forEach(room => {
            // 如果是診間模式，只顯示自己的房間；如果是櫃台模式(myRoomId為null)，顯示全部
            if (myRoomId !== null && myRoomId != room.id) return;

            const div = document.createElement('div');
            div.className = 'room-row';
            
            const name = document.createElement('span');
            name.className = 'room-name';
            name.innerText = room.name;

            const light = document.createElement('div');
            // status 為 1 是紅燈，0 是綠燈
            light.className = `light ${room.status === 1 ? 'red' : 'green'}`;
            
            // 權限判斷：非自己診間且不是櫃台，就加上不可點擊樣式
            if (myRoomId !== null && myRoomId != room.id) {
                light.classList.add('disabled');
            } else {
                light.onclick = () => toggle(room.id);
            }

            div.appendChild(name);
            div.appendChild(light);
            app.appendChild(div);
        });
    }

    // 初始化與定期刷新 (每3秒抓一次資料)
    refreshStatus();
    setInterval(refreshStatus, 3000);

</script>
</body>
</html>
