<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>診所燈號系統</title>
<link rel="icon" type="image/svg+xml" href="vertical-traffic-light-svgrepo-com.svg">
    <style>
        body { font-family: sans-serif; background: #f0f2f5; margin: 0; padding: 10px; overflow: hidden; }
        .container { display: flex; flex-direction: column; gap: 10px; }
        .room-row { display: flex; align-items: center; justify-content: space-between; 
                   background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .room-name { font-weight: bold; font-size: 16px; color: #333; }
        .light { width: 40px; height: 40px; border-radius: 50%; cursor: pointer; border: 3px solid #ddd; transition: 0.3s; }
        .light.red { background-color: #ff4d4f; box-shadow: 0 0 10px #ff4d4f; }
        .light.green { background-color: #52c41a; box-shadow: 0 0 10px #52c41a; }
        .disabled { cursor: not-allowed; opacity: 0.6; }
        #loading { position: fixed; top: 0; right: 0; font-size: 10px; color: #ccc; padding: 5px; }
    </style>
</head>
<body>

<div id="loading">同步中...</div>
<div id="app" class="container">
    </div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbyCTfASN8xBtckViSGKFi0099zy7RfH1P2k7xqkNHP1H-b2sGKPNX30LRSRpXASIYTD/exec"; 
    const urlParams = new URLSearchParams(window.location.search);
    
    // 重點修改：如果網址是 ?room=1，我們在程式內把它當作 0 (陣列的第一個)
    const rawRoomParam = urlParams.get('room');
    const myRoomId = rawRoomParam ? (parseInt(rawRoomParam) - 1) : null;

    // JSONP 工具 (保持不變)
    function jsonp(url) {
        return new Promise((resolve) => {
            const callbackName = 'jsonp_cb_' + Math.round(100000 * Math.random());
            window[callbackName] = (data) => {
                delete window[callbackName];
                document.body.removeChild(script);
                resolve(data);
            };
            const script = document.createElement('script');
            script.src = `${url}${url.indexOf('?') >= 0 ? '&' : '?'}callback=${callbackName}`;
            document.body.appendChild(script);
        });
    }

    async function refreshStatus() {
        try {
            const data = await jsonp(`${GAS_URL}?action=getStatus`);
            render(data);
            document.getElementById('loading').innerText = '已同步';
        } catch (e) {
            document.getElementById('loading').innerText = '連線中...';
        }
    }

    async function toggle(id) {
        // 這裡的 id 是從 0 開始的索引
        if (myRoomId !== null && myRoomId !== id) return;
        document.getElementById('loading').innerText = '傳送中...';
        await jsonp(`${GAS_URL}?action=toggle&roomId=${id}`);
        refreshStatus();
    }

    function render(data) {
        const app = document.getElementById('app');
        app.innerHTML = '';

        data.forEach(room => {
            // myRoomId 已經被我們減 1 了，所以可以直接跟 room.id (0, 1, 2...) 比較
            if (myRoomId !== null && myRoomId !== room.id) return;

            const div = document.createElement('div');
            div.className = 'room-row';
            
            const name = document.createElement('span');
            name.className = 'room-name';
            name.innerText = room.name;

            const light = document.createElement('div');
            light.className = `light ${room.status === 1 ? 'red' : 'green'}`;
            
            if (myRoomId !== null && myRoomId !== room.id) {
                light.classList.add('disabled');
            } else {
                light.onclick = () => toggle(room.id);
            }

            div.appendChild(name);
            div.appendChild(light);
            app.appendChild(div);
        });
    }

    refreshStatus();
    setInterval(refreshStatus, 3000);

</script>
</body>
</html>
